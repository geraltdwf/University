--PODSTAWOWE ZAPYTANIA SELECT-------
------------------------------------
--WYSWIETL ZAWARTOSC TABELI KLIENT
SELECT * FROM KLIENT;
---------------------------------------------
--WYSWIETL ZAWARTOSC TABELI DORADCA_FINANSOWY
SELECT * FROM DORADCA_FINANSOWY;
--------------------------------------------
--WYSWIETL ZAWARTOSC TABELI TOWARZYSTWA_UBEZPIECZENIOWE
SELECT * FROM TOWARZYSTWA_UBEZPIECZENIOWE;
--------------------------------------------
--WYSWIETL TABELE OBSLUGI KLIENTA
SELECT * FROM JEST_OBSLUGIWANY;
--------------------------------------------
--WYSWIETL TABELE POLISA_UB
SELECT * FROM POLISA_UB;
--------------------------------------------
--WYSWIETL TABELE LICENCJI
SELECT * FROM LICENCJA;
---------------------------------------------
---------------------------------------------
--ZAPYTANIA SELECT CD.2
---------------------------------------------
--WYSWIETL ZAWARTOSC TABELI KLIENT POSORTOWANEJ POPRZEZ MIASTA
SELECT * FROM KLIENT ORDER BY MIASTO;
--WYSWIETL ZAWARTOSC TABELI POLISA_UB POSORTOWANEJ WEDLUG SKLADEK POLIS NA ZYCIE (UNZ) - Od najwiekszej do najmniejszej
SELECT * FROM POLISA_UB WHERE RODZAJ_POLISY = 'UNZ' ORDER BY SKLADKA DESC;
--WYSWIETL POLISY, KTORYCH SUMA UBEZPIECZENIA >= 500000 ORAZ RODZAJ POLISY TO UBEZPIECZE NA ZYCIE(UNZ)
SELECT * FROM POLISA_UB WHERE SUMA_UBEZPIECZENIA >= 500000 AND RODZAJ_POLISY = 'UNZ';
--WYSWIETL POLISY, KTORYCH SUMA UBEZPIECZENIA WYNOSI NULL - SA TO POLISY INWESTYCYJNE LUB OC, KTORE NIE MAJA OKRESLONEJ SUMY UBEZPIECZENIOWEJ
SELECT * FROM POLISA_UB WHERE SUMA_UBEZPIECZENIA IS NULL;
--WYSWIETL TABELE DORADCA_FINANSOWY POSORTOWANEJ WEDLUG ROSNACEGO LICZNIKA PLACOWEGO
SELECT * FROM DORADCA_FINANSOWY ORDER BY PRZELICZNIK_PLACOWY ASC;
--WYSWIETL IMIE, NAZWISKO ORAZ ID_DORADCY Z TABELI DORADCY FINANSOWEGO
SELECT IMIE, NAZWISKO, ID_DORADCY FROM DORADCA_FINANSOWY;
--WYSWIETLANIE ROCZNEGO KOSZTU SKLADKI ZA UBEZPIECZENIE
SELECT *, SKLADKA*12 AS ROCZNY_KOSZT FROM POLISA_UB;
--WYSWIETL ROCZNY KOSZT SKLADKI ZA UBEZPIECZENIA EMERYTALNE (UL - UNITY LINQ) ORAZ POSORTUJ MALEJACO PRZEZ ROCZNY_KOSZT;
SELECT *, SKLADKA*12 AS ROCZNY_KOSZT FROM POLISA_UB WHERE RODZAJ_POLISY = 'UL' ORDER BY ROCZNY_KOSZT DESC;
--WYSWIETL KLIENTOW, KTORZY NIE PODALI INFORMACJI O SWOICH ZAROBKACH BADZ TEZ ICH NIE POSIADJA
SELECT * FROM KLIENT WHERE MSC_ZAROBKI_PLN_NETTO IS NULL;
--WYSWIETL LICENCJE, KTORE ZOSTALY WYDANE PRZED 2010 ROKIEM
SELECT * FROM LICENCJA WHERE DATA_WYDANIA < '2010-01-01';
--WYSWIETL ZLACZONE POPRZEZ KONKATENCJE POLA ID LICENCJI ORAZ RODZAJ LICENCJI Z TABELI DORADCA FINANSOWY
SELECT DATA_WYDANIA, ID_LICENCJI || ', ' || RODZAJ AS LICENCJA FROM LICENCJA;
;
--WYSWIETL DORADCE KTORY NIE POSIADA ZADNEGO KLIENTA W BAZIE
SELECT DORADCA_FINANSOWY.IMIE || '  ' || DORADCA_FINANSOWY.NAZWISKO AS BEZ_KLIENTOW FROM DORADCA_FINANSOWY WHERE ID_DORADCY NOT IN(SELECT ID_DORADCY_NR FROM JEST_OBSLUGIWANY);
----------------------------------------------
--ZAPYTANIA GROUP COUNT FUNKCJE AGREGUJACE----
----------------------------------------------
--WYSWEITL SREDNI KOSZT SKLADKI ROCZNEJ ZA POLISY NA ZYCIE, ZAOKROAGLNIJ DO 2 MIEJSCA PO PRZECINKU, GRUPUJ WEDLUG NR_POLISY
SELECT NR_POLISY, ROUND(AVG(SKLADKA*12),2) AS SREDNI_ROCZNY_KOSZT_UNZ FROM POLISA_UB WHERE RODZAJ_POLISY = 'UNZ' GROUP BY 1;
--WYSWIETL WYSOKOSC SKLADKI ORAZ ILOSC UBEZPIECZEN EMERYTALNYCH W TABLELI POLISA_UB GROUP WEDLUG SKLADKI 
SELECT SKLADKA, COUNT(*) AS UNITY_LINQ FROM POLISA_UB WHERE RODZAJ_POLISY ='UL' GROUP BY SKLADKA;
SELECT SKLADKA, COUNT(*) AS UNITY_LINQ FROM POLISA_UB WHERE RODZAJ_POLISY ='UL' GROUP BY 1;
SELECT SKLADKA, DATA_WYGASNIECIA, COUNT(*) AS UNITY_LINQ FROM POLISA_UB WHERE RODZAJ_POLISY ='UL' GROUP BY 1,2;
--WYSWIETL ILOSC WYDANYCH LICENCJI NA UBEZPIECZENIA EMERYTALNE
SELECT RODZAJ,COUNT(*) WYDANE_LICENCJE FROM LICENCJA WHERE RODZAJ LIKE '%emerytalne%' group by 1;
--WYSWIETL NAJWIEKSZA SKLADE ZA POLISE UBEZPIECZENIOWA NA ZYCIE
SELECT MAX(SKLADKA) AS NAJWYZSZA_SKLADKA FROM POLISA_UB WHERE RODZAJ_POLISY LIKE '%UNZ%';
--WYSWIETL NAJTANSZE UBEZPIECZENIE OC W SKALI ROCZNEJ
SELECT MIN(SKLADKA*12) AS NAJTANSZE_OC FROM POLISA_UB WHERE RODZAJ_POLISY LIKE '%OC%';
--WYSWIELT SUME SKLADEK MIESIECZNYCH NA UBEZPIECZENIA ZDROWOTNE SPRZEDANE PRZEZ WSZYSTKICH DORADCOW I ILOSC UMOW
SELECT COUNT(*), SUM(SKLADKA) AS ZYSK_DLA_TOWARZYSTW_MSC FROM POLISA_UB WHERE RODZAJ_POLISY LIKE '%UZ%';
----------------------------------------------
--OPERATORY LOGICZNE--------------------------
----------------------------------------------
--WYSWIETL POLISY, KTORE WYGASAJA DO KONCA 2019 ROKU
SELECT * FROM POLISA_UB WHERE DATA_WYGASNIECIA BETWEEN '2019-05-26' AND '2019-12-31';
--WYSWIETL IMIE, NAZWISKO I MIASTO Z TABELI KLIENT GDZIE MIASTO TO WARSZAWA LUB BYDGOSZCZ
SELECT IMIE, NAZWISKO, MIASTO FROM KLIENT WHERE MIASTO LIKE '%Warszawa%' OR MIASTO LIKE '%Bydgoszcz%' ORDER BY MIASTO;
--WYSWIETL TOWARZYSTWA KTORYCH FILIE NIE ZNAJDUJA SIE W PONIZSZCZY MIASTACH
SELECT * FROM TOWARZYSTWO_UBEZPIECZENIOWE WHERE FILIA NOT IN ('Warszawa', 'Gdansk', 'Poznan', 'Bydgoszcz');
--WYSWIETL TOWARZYSTA KTORYCH FORMA PRAWNA TO TOWARZYSTWA UBEZPIECZEN WZAJEMNYCH
SELECT * FROM TOWARZYSTWO_UBEZPIECZENIOWE WHERE FORMA_PRAWNA IN ('TUW');
----------------------------------------------
--ZAPYTANIA ZAGNIEZDZONE SKORELOWANE----------
--INNER JOIN----------------------------------
--WYSWIETL IMIE, NAZWISKO I ODDZIAL DORADCOW KTORZY POSIADAJA LICENCJE NA UNZ
SELECT IMIE, NAZWISKO, ODDZIAL FROM DORADCA_FINANSOWY WHERE ID_DORADCY IN (SELECT ID_DORADCY FROM LICENCJA WHERE RODZAJ LIKE '%zycie%')  ORDER BY NAZWISKO;
--WYSWIETL DORADCOW I ICH KLIENTOW
SELECT DORADCA_FINANSOWY.IMIE || ' ' ||  DORADCA_FINANSOWY.NAZWISKO AS DORADCA, DORADCA_FINANSOWY.ID_DORADCY, 
KLIENT.IMIE || ' ' || KLIENT.NAZWISKO AS KLIENT,
KLIENT.PESEL FROM (
    (DORADCA_FINANSOWY INNER JOIN 
    JEST_OBSLUGIWANY 
    ON DORADCA_FINANSOWY.ID_DORADCY = JEST_OBSLUGIWANY.ID_DORADCY_NR)
    INNER JOIN KLIENT 
    ON JEST_OBSLUGIWANY.PESEL_NR = KLIENT.PESEL) 
    ORDER BY DORADCA_FINANSOWY.NAZWISKO;
--WYSWIETL DORADCOW, KLIENT I ICH POLISY, KTORE SA POLISAMI INWESTYCJNYMI
SELECT KLIENT.IMIE || ' ' || KLIENT.NAZWISKO AS KLIENT, KLIENT.PESEL,
DORADCA_FINANSOWY.IMIE || ' ' || DORADCA_FINANSOWY.NAZWISKO AS DORADCA, DORADCA_FINANSOWY.ID_DORADCY,
POLISA_UB.NR_POLISY, POLISA_UB.RODZAJ_POLISY FROM (
    (KLIENT INNER JOIN POLISA_UB 
    ON KLIENT.PESEL = POLISA_UB.PESEL) 
    INNER JOIN DORADCA_FINANSOWY
    ON DORADCA_FINANSOWY.ID_DORADCY = POLISA_UB.ID_DORADCY
    ) WHERE POLISA_UB.RODZAJ_POLISY LIKE '%UI%';
--WYSWIETL TOWARZYSTWA KTORE SA W POSIADANIU WIECEJ NIZ 3 POLIS 
SELECT TOWARZYSTWO_UBEZPIECZENIOWE.NAZWA_PRZEDSIEBIORSTWA || ', ' || TOWARZYSTWO_UBEZPIECZENIOWE.FILIA AS TOWARZYSTWO, COUNT(*) AS ILOSC_POLIS 
FROM (TOWARZYSTWO_UBEZPIECZENIOWE INNER JOIN
POLISA_UB ON TOWARZYSTWO_UBEZPIECZENIOWE.KRS = POLISA_UB.KRS) GROUP BY 1 HAVING COUNT(*) > 3;
----------------------------------------------
--UPDATE--------------------------------------
----------------------------------------------
--AKUTALIZACJA ZAROBKOW KLIENTA---------------
UPDATE KLIENT SET MSC_ZAROBKI_PLN_NETTO = 5000 
WHERE IMIE = 'Jan' AND  NAZWISKO = 'Czwartek';
--AKUTALIZACJA ZAROBKOW KLIENTOW, KTORZY NIE PODALI WCZESNIEJ INFORMACJI O DOCHODACH
UPDATE KLIENT SET MSC_ZAROBKI_PLN_NETTO = 1600 
WHERE MSC_ZAROBKI_PLN_NETTO IS NULL;
--INDEKSACJA SKLADEK ZA UBEZPIECZENIA EMERYTALNE KTORE WYGASAJA POMIEDZY 2030-2040 ROKIEM
UPDATE POLISA_UB SET SKLADKA = SKLADKA*1.07 
WHERE RODZAJ_POLISY = 'UL' 
AND DATA_WYGASNIECIA 
BETWEEN '2030-01-01' AND '2040-01-01';
--ZWIEKSZ SKLADKE UBEZPIECZEN KLIENTOM, KTORYCH ZARBOKI PRZEKRACZAJA LUB WYNOSZA 9000
UPDATE POLISA_UB SET SKLADKA = SKLADKA*1.30 
WHERE PESEL IN (
SELECT PESEL
FROM KLIENT 
WHERE MSC_ZAROBKI_PLN_NETTO >= 9000
);
--ZWIEKSZ STAWKE PROWIZYJNA DORADCOM, KTORZY POSIADAJA WIECEJ 2 LUB WIECEJ KLIENTOW W OBSLUDZE
UPDATE DORADCA_FINANSOWY SET PRZELICZNIK_PLACOWY = '20' 
WHERE ID_DORADCY IN (
SELECT ID_DORADCY 
FROM DORADCA_FINANSOWY 
INNER JOIN JEST_OBSLUGIWANY 
ON JEST_OBSLUGIWANY.ID_DORADCY_NR = DORADCA_FINANSOWY.ID_DORADCY
GROUP BY 1
HAVING COUNT(*) >= 1
);
----------------------------------------------
--DELETE--------------------------------------
----------------------------------------------
--WYCZYSZCZENIE TABELI POLIS UBEZPIECZENIOWYCH
DELETE FROM POLISA_UB;
--USUNIECIE POLISY, KTOREJ SKLADKA WYNOSI 50 ZL
DELETE FROM POLISA_UB WHERE SKLADKA = 50;
--USUNIECIE WSZYSTKICH POLIS OC
DELETE FROM POLSA_UB WHERE RODZAJ_POLISY = 'OC';
--USUNIECIE KLIENTOW KTORZY POSIADAJA ZAROBKI MNIEJSZE NIZ 2000 ZL
DELETE FROM KLIENT WHERE MSC_ZAROBKI_PLN_NETTO < 2000;
--USUN WSZYSTKIE LICENCJE ZDROWOTNE;
DELETE FROM LICENCJA WHERE RODZAJ LIKE '%zdrowotne%' AND ID_DORADCY IN (SELECT ID_DORADCY FROM DORADCA_FINANSOWY);
--USUN WSZYSTKIE POLISY KLIENTOM KTORYCH ZAROBKI SA PONIZEJ 5000 ZL
DELETE FROM POLISA_UB WHERE PESEL IN (SELECT PESEL FROM KLIENT WHERE MSC_ZAROBKI_PLN_NETTO < 5000);
--USUN TOWARZYSTWA, KTORYCH GLOWNA SIEDZIBA TO WARSZAWA I MAJA 2 LUB MNIEJ SPRZEDANYCH UMOW
DELETE FROM TOWARZYSTWO_UBEZPIECZENIOWE WHERE MIASTO LIKE '%Warszawa%' AND KRS IN (
SELECT KRS FROM TOWARZYSTWO_UBEZPIECZENIOWE
INNER JOIN POLISA_UB
ON TOWARZYSTWO_UBEZPIECZENIOWE.KRS = POLISA_UB.KRS_NR GROUP BY 1 HAVING COUNT(*) <= 2);
----------------------------------------------
--DODANIE TABELI------------------------------
----------------------------------------------
--DODANIE NOWEJ KOLUMNY - PROWIZJA DO TABELI POLISY
ALTER TABLE POLISA_UB ADD PROWIZJA INTEGER;
--USUNIECIE NOWEJ KOLUMNY
ALTER TABLE POLISA_UB DROP COLUMN PROWIZJA;
--DODANIE KOLUMNY - USTAWIENIE WARTOSCI DOMYSLNEJ NA 10
ALTER TABLE POLISA_UB ADD PROWIZJA INTEGER NOT NULL DEFAULT 10;
----------------------------------------------
---TWORZENIE WIDOKU---------------------------
----------------------------------------------
CREATE VIEW KLIENT_WARSZAWA AS SELECT IMIE, NAZWISKO, PESEL, MIASTO FROM KLIENT WHERE MIASTO = 'Warszawa';
CREATE VIEW TOWARZYSTWO_POZNAN AS SELECT KRS, MIASTO, FILIA FROM TOWARZYSTWO_UBEZPIECZENIOWE WHERE MIASTO = 'Poznan';
----------------------------------------------
----------------------------------------------
